<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Syncing...</title>
</head>
<body style="background:#0d0d0d;color:#e0e0e0;font-family:Inter,sans-serif;text-align:center;padding:2rem;">
  <h1>ğŸ”„ Syncing Playlist...</h1>
  <div id="output">Please wait...</div>

  <script>
    const YT_API    = 'AIzaSyDCNlcTnjlEvaVI_Xga-kBYt1XBrwJCooY';
    const code      = new URLSearchParams(window.location.search).get('code');
    const ytUrl     = localStorage.getItem('ytUrl');
    const ytPlaylistId = ytUrl.match(/[?&]list=([a-zA-Z0-9_-]+)/)?.[1];

    console.log('[callback] spotify code:', code);
    console.log('[callback] ytPlaylistId:', ytPlaylistId);

    fetch(`/api/spotify-auth?code=${code}`)
      .then(res => res.json())
      .then(async data => {
        const accessToken = data.access_token;
        console.log('[callback] got accessToken:', accessToken?.slice(0,10) + 'â€¦');

        const ytRes = await fetch(
          `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=10&playlistId=${ytPlaylistId}&key=${YT_API}`
        );
        const items = (await ytRes.json()).items;
        console.log('[callback] fetched YouTube items:', items.length);

        const uris = [];
        for (const item of items) {
          const title = item.snippet.title;
          console.log('[callback] querying Gemini for title:', title);

          // Debug: log the exact fetch youâ€™re about to do
          const geminiPayload = { prompt: `Is "${title}" a song? If yes, give the best Spotify search query.` };
          console.log('[callback] POST /api/gemini payload:', geminiPayload);

          const geminiRes = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(geminiPayload)
          });

          console.log('[callback] Gemini proxy status:', geminiRes.status);
          const geminiJson = await geminiRes.json();
          console.log('[callback] Gemini response body:', geminiJson);

          const geminiText = geminiJson?.candidates?.[0]?.content?.parts?.[0]?.text || '';
          if (!geminiText.toLowerCase().includes('yes')) {
            console.log('[callback] skipping non-song:', title);
            continue;
          }

          const query = geminiText.split('Query:')[1]?.trim() || title;
          console.log('[callback] final Spotify search query:', query);

          const spotifyRes = await fetch(
            `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`,
            { headers: { Authorization: `Bearer ${accessToken}` } }
          );
          const track = (await spotifyRes.json()).tracks.items[0];
          if (track) {
            uris.push(track.uri);
            console.log('[callback] got track URI:', track.uri);
          }
        }

        if (uris.length === 0) {
          return document.getElementById('output').innerText =
            'âš ï¸ No valid tracks found to sync.';
        }

        // ... rest of your playlist creation logic, unchanged ...
      })
      .catch(err => {
        console.error('[callback] fatal error', err);
        document.getElementById('output').innerText =
          'âŒ Unexpected error â€“ check console.';
      });
  </script>
</body>
</html>
